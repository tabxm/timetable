<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>University Timetable (IT)</title>

  <style>
    :root{
      --slotW: 92px;
      --labelW: 140px;
      --bg:#0b1020;
      --text:#e9eefc;
      --muted:#a9b4d6;
      --line:#2a3766;
      --warn:#ffcc00;
      --bad:#ff5a7a;
      --ok:#43d19e;
      --radius:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:linear-gradient(180deg,#050818,var(--bg));color:var(--text)}
    header{
      position:sticky;top:0;z-index:50;
      background:rgba(5,8,24,0.9);backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(42,55,102,0.6);
    }
    .wrap{max-width:1320px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid rgba(42,55,102,0.9);border-radius:999px;color:var(--muted);font-size:12px}
    .hidden{display:none !important}
    .disabled{opacity:0.55;pointer-events:none}
    main .wrap{padding-top:10px}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:14px}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg,rgba(18,26,51,0.98),rgba(15,23,48,0.98));
      border:1px solid rgba(42,55,102,0.9);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .card h2{font-size:14px;margin:0 0 10px 0;color:#dbe4ff}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea, button{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(42,55,102,0.9);
      background:rgba(12,18,38,0.9);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{cursor:pointer}
    .btnPrimary{background:linear-gradient(180deg,#2e4bff,#2640d8);border-color:rgba(123,149,255,0.9)}
    .btnGhost{background:transparent}
    .btnDanger{background:rgba(255,90,122,0.16);border-color:rgba(255,90,122,0.5)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .msg{margin-top:10px;font-size:12px;padding:10px;border-radius:12px;border:1px solid rgba(42,55,102,0.9);background:rgba(10,14,30,0.75)}
    .msg.ok{border-color:rgba(67,209,158,0.55)}
    .msg.warn{border-color:rgba(255,204,0,0.55)}
    .msg.bad{border-color:rgba(255,90,122,0.55)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar > *{flex:1}
    .toolbar .small{flex:0.9}
    .toolbar .tiny{flex:0.6}
    .smallText{font-size:11px;color:var(--muted)}
    .hr{height:1px;background:rgba(42,55,102,0.65);margin:10px 0}

    /* Timeline view */
    .timelineWrap{overflow:auto;max-width:100%;-webkit-overflow-scrolling:touch}
    .rowPanel{
      border:1px solid rgba(42,55,102,0.9);
      border-radius:14px;
      background:rgba(10,14,30,0.35);
      padding:10px;
      margin-bottom:12px;
      min-width:0;
    }
    .rowPanelHead{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:10px;
    }
    .rowKey{
      font-size:13px;font-weight:700;color:#e9eefc;
      padding:8px 10px;border-radius:12px;
      background:rgba(18,26,51,0.55);
      border:1px solid rgba(42,55,102,0.9);
    }
    .rowMeta{
      font-size:11px;color:var(--muted);
      padding:8px 10px;border-radius:12px;
      background:rgba(18,26,51,0.25);
      border:1px solid rgba(42,55,102,0.75);
    }

    .timeHeader{
      display:grid;
      gap:6px;
      margin-bottom:8px;
      position:sticky;
      top:62px;
      z-index:5;
      background:rgba(11,16,32,0.92);
      padding:8px 0;
    }
    .timeHeadCell{
      text-align:center;
      font-size:10px;
      color:#dbe4ff;
      padding:6px 4px;
      border-radius:10px;
      border:1px solid rgba(42,55,102,0.75);
      background:rgba(18,26,51,0.35);
      white-space:nowrap;
    }

    .laneGrid{
      display:grid;
      gap:10px;
      align-items:stretch;
    }
    .dayLabel{
      padding:12px 10px;border-radius:12px;
      border:1px solid rgba(42,55,102,0.85);
      background:rgba(18,26,51,0.25);
      font-size:12px;color:#dbe4ff;
      position:sticky;
      left:0;
      z-index:4;
      display:flex;
      align-items:center;
      min-height:0;
    }
    .lane{
      border-radius:12px;
      border:1px dashed rgba(42,55,102,0.75);
      background:rgba(18,26,51,0.12);
      min-height:0;
      position:relative;

      /* IMPORTANT: allow tall blocks to render fully */
      overflow:visible;
    }
    .lane.dropHover{outline:2px solid rgba(67,209,158,0.65)}
    .lane .bgTicks{
      position:absolute;inset:0;
      display:grid;
      opacity:0.35;
      pointer-events:none;
    }
    .lane .bgTicks > div{
      border-right:1px solid rgba(42,55,102,0.55);
    }

    /* Blocks expand with content and wrap */
    .block{
      border-radius:12px;
      border:1px solid rgba(123,149,255,0.55);
      background:linear-gradient(180deg,rgba(46,75,255,0.18),rgba(29,42,87,0.35));
      padding:10px 10px;
      cursor:grab;
      user-select:none;

      height:auto;
      min-height:120px;
      overflow:visible;
    }
    .block:active{cursor:grabbing}
    .block.conflict{
      border-color:rgba(255,90,122,0.95);
      background:linear-gradient(180deg,rgba(255,90,122,0.22),rgba(29,42,87,0.35));
    }
    .block.selected{outline:2px solid rgba(255,204,0,0.65)}

    .block.added{
      border-color:rgba(67,209,158,0.95);
      background:linear-gradient(180deg,rgba(67,209,158,0.18),rgba(29,42,87,0.35));
    }
    .block.updated{
      border-color:rgba(255,204,0,0.95);
      background:linear-gradient(180deg,rgba(255,204,0,0.16),rgba(29,42,87,0.35));
    }

    .block .t{
      font-size:12px;color:#e9eefc;font-weight:850;line-height:1.2;
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .block .s{
      font-size:11px;color:var(--muted);margin-top:6px;line-height:1.25;
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    .chip{
      display:inline-block;
      margin-top:8px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(29,42,87,0.75);
      border:1px solid rgba(42,55,102,0.8);
      font-size:10px;color:#cfe0ff;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .notes{
      margin-top:6px;
      max-height:52px;
      overflow:auto;
      padding-right:6px;
    }

    /* Conflict modal */
    .modalBackdrop{
      position:fixed; inset:0; z-index:200;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(980px, 100%);
      max-height:85vh;
      overflow:auto;
      background:linear-gradient(180deg,rgba(18,26,51,0.98),rgba(15,23,48,0.98));
      border:1px solid rgba(42,55,102,0.95);
      border-radius:16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.5);
      padding:14px;
    }
    .modalHead{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;
      border-bottom:1px solid rgba(42,55,102,0.65);
      padding-bottom:10px;
      margin-bottom:10px;
    }
    .modalTitle{font-weight:850; font-size:14px; color:#dbe4ff}
    .confRow{
      border:1px solid rgba(42,55,102,0.75);
      background:rgba(10,14,30,0.35);
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
    }
    .confRow .k{font-size:11px;color:var(--muted)}
    .confRow .v{font-size:12px;color:#e9eefc;font-weight:750;margin-top:4px}
    .confBadge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,204,0,0.5);
      background:rgba(255,204,0,0.12);
      color:#ffe59a;
      font-size:11px;
      margin-right:8px;
    }

    @media print{
      header, .card:first-child, .modalBackdrop{ display:none !important; }
      body{ background:#ffffff !important; color:#000000 !important; }
      .card{ border:none !important; box-shadow:none !important; background:#ffffff !important; }
      .rowPanel{ break-inside: avoid; border:1px solid #000 !important; background:#fff !important; }
      .timeHeadCell, .dayLabel, .rowKey, .rowMeta{ color:#000 !important; border-color:#000 !important; }
      .lane{ border-color:#000 !important; }
      .block{ border-color:#000 !important; background:#fff !important; color:#000 !important; }
      .block .s, .smallText{ color:#000 !important; }
    }
  
    /* Viewer layout: use full width, no left column gap */
    body.viewerMode .wrap{max-width:100%; padding:12px 14px}
    body.viewerMode .layout{grid-template-columns:1fr}
    body.viewerMode .layout > section{min-width:0}

    /* Header controls */
    .topControls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .topControls select{height:36px; padding:6px 10px; border-radius:12px; border:1px solid rgba(42,55,102,0.9);
      background:rgba(12,18,40,0.85); color:var(--text); outline:none}
    .topControls label{font-size:12px; color:var(--muted)}
    .topGroup{display:flex; gap:6px; align-items:center}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      header .row{align-items:flex-start}
    }



    /* Responsive timeline sizing */
    .rowPanel{width:100%}
    .rowPanelHead{flex-wrap:wrap}
    .timeHeader, .laneGrid{min-width:0}

    @media (max-width:900px){
      :root{ --slotW: 78px; --labelW: 120px; }
      .rowKey{max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    }
    @media (max-width:600px){
      :root{ --slotW: 64px; --labelW: 110px; }
      .timeHeadCell{font-size:9px; padding:5px 3px}
      .dayLabel{font-size:11px; padding:10px 8px}
    }
    @media (max-width:420px){
      :root{ --slotW: 56px; --labelW: 104px; }
    }


    /* Ramadan toggle + compact grid when many columns */
    .btnToggle{
      width:auto;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(42,55,102,0.9);
      background:rgba(12,18,40,0.85);
      color:var(--text);
      cursor:pointer;
    }
    .btnToggle.on{
      background:linear-gradient(180deg,#2e4bff,#2640d8);
      border-color:rgba(123,149,255,0.9);
    }
    body.ramadanMode{
      --slotW: 44px;
      --labelW: 130px;
    }
    @media (max-width:600px){
      body.ramadanMode{ --slotW: 36px; --labelW: 110px; }
    }

</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <h1>University Timetable (IT)</h1>
        <span class="pill" id="verPill">v1</span>
      </div>
      <div class="row topControls" style="gap:8px">
        <span class="pill" id="authPill">Mode: Viewer</span>
        <div class="topGroup">
          <label for="rowModeTop">Rows</label>
          <select id="rowModeTop">
            <option value="room" selected>Rooms</option>
            <option value="section">Sections</option>
            <option value="instructor">Instructors</option>
            <option value="course" data-admin-only="1">Courses</option>
          </select>
        </div>
        <div class="topGroup">
          <label for="rowFilterTop">Only</label>
          <select id="rowFilterTop">
            <option value="__all__" selected>All</option>
          </select>
        </div>
<button id="loginBtn" style="width:auto;padding:8px 10px;border-radius:12px">Admin login</button>
<button id="logoutBtn" class="hidden" style="width:auto;padding:8px 10px;border-radius:12px">Logout</button>
<button id="draftSaveBtn" class="hidden" style="width:auto;padding:8px 10px;border-radius:12px">Save draft</button>
<button id="publishBtn" class="hidden btnPrimary" style="width:auto;padding:8px 10px;border-radius:12px">Publish</button>
<button id="cloudLoadBtn" style="width:auto;padding:8px 10px;border-radius:12px">Reload</button>
        <button id="ramadanToggleBtn" class="btnToggle" style="width:auto">Ramadan: Off</button>
        <span class="pill" id="confStat">Conflicts: 0</span>
        <button id="confBtn" style="width:auto;padding:8px 10px;border-radius:12px">View conflicts</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="layout">

      <section class="card" id="editorCard">
        <h2>Class editor</h2>

        <label>Course</label>
        <input id="course" placeholder="e.g., CS-202 Data Structures" />

        <div class="row" style="gap:10px">
          <div style="flex:1">
            <label>Section</label>
            <input id="section" placeholder="e.g., 2A / 2B" />
          </div>
          <div style="flex:1">
            <label>Instructor</label>
            <input id="instructor" placeholder="Name" />
          </div>
        </div>

        <div class="row" style="gap:10px">
          <div style="flex:1">
            <label>Room</label>
            <input id="room" placeholder="e.g., 294 / IT Lab 1" />
          </div>
          <div style="flex:1">
            <label>Day</label>
            <select id="day">
              <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option>
            </select>
          </div>
        </div>

        <div class="row" style="gap:10px">
          <div style="flex:1">
            <label>Start time</label>
            <select id="start"></select>
          </div>
          <div style="flex:1">
            <label>Duration (minutes)</label>
            <select id="dur">
              <option value="60">60</option>
              <option value="90">90</option>
              <option value="120">120</option>
              <option value="180">180</option>
            </select>
          </div>
        </div>

        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Any constraints or notes"></textarea>

        <div class="btnRow">
          <button class="btnPrimary" id="saveBtn">Save (Add or Update)</button>
          <button class="btnGhost" id="newBtn">New class</button>
          <button class="btnDanger" id="deleteBtn">Delete selected</button>
        </div>

        <div class="hr"></div>

        <h2>View settings</h2>
        <div class="toolbar">
          <div class="small">
            <label>View as</label>
            <select id="rowMode">
              <option value="room" selected>Rooms</option>
              <option value="section">Sections (2A, 2B, etc.)</option>
              <option value="instructor">Instructors</option>
              <option value="course" data-admin-only="1">Courses</option>
            </select>
          </div>
          <div class="tiny">
            <label>Start</label>
            <select id="dayStart"></select>
          </div>
          <div class="tiny">
            <label>End</label>
            <select id="dayEnd"></select>
          </div>
        </div>

        <div class="toolbar" style="margin-top:6px">
          <div class="tiny">
            <label>Slot size</label>
            <select id="slotSize">
              <option value="30" selected>30 min</option>
              <option value="60">60 min</option>
            </select>
          </div>
          <div class="small">
            <label>Rows list (comma separated)</label>
            <input id="rowList" placeholder="Auto updates per view mode" />
          </div>
          <div class="tiny">
            <label>Apply</label>
            <button id="applyRows" class="btnPrimary">Update</button>
          </div>
        </div>

        <div class="btnRow">
          <button id="downloadJsonBtn">Download JSON</button>
          <button id="copyJsonBtn">Copy JSON</button>
          <button id="printBtn">Print / Save as PDF</button>
          <button id="shareBtn">Share</button>
        </div>

        <div class="btnRow">
          <button id="importBtn">Import JSON</button>
          <button class="btnDanger" id="resetBtn">Reset all</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Overlaps are stacked, nothing disappears.
          Red border means overlap exists within the current view key.
          Notes scroll inside the card if long.
        </div>

        <div id="msg" class="msg" style="display:none"></div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2 style="margin:0">Timeline grid</h2>
            <div class="smallText" id="gridSub">Rows: Rooms</div>
          </div>
          <div class="smallText" id="selInfo"></div>
        </div>

        <div class="timelineWrap" style="margin-top:12px">
          <div id="gridRoot"></div>
        </div>
      </section>

    </div>
  </div>
</main>

<div class="modalBackdrop" id="confModal">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Conflicts</div>
        <div class="smallText" id="confSummary"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div style="min-width:220px">
          <label style="margin:0 0 6px">Show</label>
          <select id="confFilter">
            <option value="all" selected>All (Room, Instructor, Section)</option>
            <option value="room">Room only</option>
            <option value="instructor">Instructor only</option>
            <option value="section">Section only</option>
          </select>
        </div>
        <button id="closeConf" style="width:auto;padding:10px 12px;border-radius:12px">Close</button>
      </div>
    </div>
    <div id="confList"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const days = ["Mon","Tue","Wed","Thu","Fri"];
  const pad2 = n => String(n).padStart(2,"0");
  const toMin = (hhmm) => { const [h,m]=hhmm.split(":").map(Number); return h*60+m; };
  const fromMin24 = (mins) => `${pad2(Math.floor(mins/60))}:${pad2(mins%60)}`;
  const to12h = (hhmm24) => {
    const [h0,m]=hhmm24.split(":").map(Number);
    const ampm = h0 >= 12 ? "PM" : "AM";
    let h = h0 % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)} ${ampm}`;
  };
  const fromMin12 = (mins) => to12h(fromMin24(mins));
  const overlaps = (aStart,aEnd,bStart,bEnd) => Math.max(aStart,bStart) < Math.min(aEnd,bEnd);
  const $ = (id)=>document.getElementById(id);
// ===== Cloud (Firebase) config (replace placeholders) =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDmgxjFoOrksMpMcgnqoAvmZ944cAe5u5Q",
    authDomain: "timetable-ddec7.firebaseapp.com",
    projectId: "timetable-ddec7",
    storageBucket: "timetable-ddec7.firebasestorage.app",
    messagingSenderId: "84849698236",
    appId: "1:84849698236:web:ce7f3eaa0cfcb2531777b9",
    measurementId: "G-YJ69FGM491"
};
const ADMIN_EMAIL = "tabxmsultan@gmail.com";
const CLOUD_DOC_PATH = "app/timetable"; // Firestore document path
const AUTO_SAVE_MS = 800;

let firebaseReady = false;
let isAdmin = false;
let autoSaveTimer = null;

function hasPlaceholders(cfg){
  const s = JSON.stringify(cfg || {});
  return s.includes("YOUR_");
}

  let classes = [];
  let rowMode = "room";
  let rowFilter = "__all__";
  let selectedId = "";

  const defaultsByMode = {
    room: ["294","296","IT Lab 1","IT Lab 2","HW Lab"],
    section: ["2A","2B","3A","3B","4A","4B"],
    instructor: [],
    course: []
  };
  const userRowsByMode = { room: null, section: null, instructor: null, course: null };

  let startMin = 8*60+30;
  let endMin = 17*60+30;
  let slotSize = 30;

  // Schedule mode toggle (Regular vs Ramadan)
  let isRamadan = false;
  let regularSnapshot = null;

  function allowedStartMinsForDay(day){
    if(!isRamadan) return null;
    if(day === "Fri") return [480,520,560,600,640,680]; // 08:00, 08:40, ..., 11:20
    return [480,535,590,645,700,755]; // 08:00, 08:55, ..., 12:35
  }

  function setDurOptionsForDay(day){
    const cur = String(durEl?.value || "");
    let opts;
    if(!isRamadan){
      opts = ["60","90","120","180"];
    } else if(day === "Fri"){
      opts = ["25","40","50","80"];
    } else {
      opts = ["35","55","70","110"];
    }
    if(!durEl) return;
    durEl.innerHTML = "";
    for(const v of opts){
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      durEl.appendChild(o);
    }
    if(cur && !opts.includes(cur)){
      const o = document.createElement("option");
      o.value = cur;
      o.textContent = cur;
      durEl.appendChild(o);
    }
    if(cur) durEl.value = cur;
  }

  function buildStartOptionsForDay(day){
    if(!startEl) return;
    startEl.innerHTML = "";

    // Regular mode: build options using the current grid step.
    if(!isRamadan){
      const step = Math.max(1, Number(slotSize) || 5);
      for(let t = startMin; t <= endMin; t += step){
        const opt = document.createElement("option");
        opt.value = fromMin24(t);
        opt.textContent = fromMin12(t);
        startEl.appendChild(opt);
      }
      return;
    }

    // Ramadan mode: only allow slot starts defined per day (Mon-Thu vs Fri).
    const mins = allowedStartMinsForDay(day) || [];
    for(const t of mins){
      if(t < startMin || t > endMin) continue;
      const opt = document.createElement("option");
      opt.value = fromMin24(t);
      opt.textContent = fromMin12(t);
      startEl.appendChild(opt);
    }
  }


  function snapMinToAllowed(mins, day){
    const allowed = allowedStartMinsForDay(day);
    if(!allowed || !allowed.length) return snapMinToSlot(mins);
    let best = allowed[0];
    let bestD = Math.abs(mins - best);
    for(const a of allowed){
      const d = Math.abs(mins - a);
      if(d < bestD){ bestD = d; best = a; }
    }
    return Math.max(startMin, Math.min(endMin, best));
  }

  function setRamadanMode(on, silent=false){
    isRamadan = !!on;
    document.body.classList.toggle("ramadanMode", isRamadan);

    const btn = $("ramadanToggleBtn");
    if(btn){
      btn.textContent = isRamadan ? "Ramadan: On" : "Ramadan: Off";
      btn.classList.toggle("on", isRamadan);
      btn.setAttribute("aria-pressed", isRamadan ? "true" : "false");
    }

    const timeCtrls = [dayStartEl, dayEndEl, slotSizeEl];
    timeCtrls.forEach(el=>{
      if(!el) return;
      el.disabled = isRamadan;
      el.classList.toggle("disabled", isRamadan);
    });

    if(isRamadan){
      if(!regularSnapshot) regularSnapshot = { startMin, endMin, slotSize };
      startMin = 8*60;          // 08:00
      endMin   = 13*60 + 30;    // 13:30
      slotSize = 5;             // fine grid for 55/40 minute blocks
    } else if(regularSnapshot){
      startMin = Number(regularSnapshot.startMin);
      endMin   = Number(regularSnapshot.endMin);
      slotSize = Number(regularSnapshot.slotSize);
      regularSnapshot = null;
    }

    if(dayStartEl) dayStartEl.value = fromMin24(startMin);
    if(dayEndEl) dayEndEl.value = fromMin24(endMin);
    if(slotSizeEl) slotSizeEl.value = String(slotSize);

    buildStartOptionsForDay(dayEl?.value || "Mon");
    setDurOptionsForDay(dayEl?.value || "Mon");
    if(startEl && !startEl.value) startEl.value = fromMin24(startMin);

    if(!silent){
      render();
      queueAutoSave();
    }
  }

  const courseEl=$("course"), sectionEl=$("section"), instructorEl=$("instructor"),
        roomEl=$("room"), dayEl=$("day"), startEl=$("start"), durEl=$("dur"),
        notesEl=$("notes"), msgEl=$("msg"), gridRoot=$("gridRoot"),
        rowModeEl=$("rowMode"), rowModeTopEl=$("rowModeTop"), rowFilterTopEl=$("rowFilterTop"), rowListEl=$("rowList"), gridSubEl=$("gridSub"),
        confStatEl=$("confStat"), dayStartEl=$("dayStart"), dayEndEl=$("dayEnd"),
        slotSizeEl=$("slotSize"), selInfoEl=$("selInfo");

  function showMsg(text,type="ok"){
    msgEl.style.display="block";
    msgEl.className = `msg ${type}`;
    msgEl.textContent = text;
  }
  function hideMsg(){ msgEl.style.display="none"; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[m]);
  }
  function uuid(){ return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function buildTimeOptions(selectEl, minStart, minEnd, step){
    selectEl.innerHTML = "";
    for(let t=minStart; t<=minEnd; t+=step){
      const opt=document.createElement("option");
      opt.value = fromMin24(t);
      opt.textContent = fromMin12(t);
      selectEl.appendChild(opt);
    }
  }
  function buildBoundaryOptions(selectEl, minStart, minEnd, step){
    selectEl.innerHTML = "";
    for(let t=minStart; t<=minEnd; t+=step){
      const opt=document.createElement("option");
      opt.value = fromMin24(t);
      opt.textContent = fromMin12(t);
      selectEl.appendChild(opt);
    }
  }

  function clearEditor(){
    courseEl.value=""; sectionEl.value=""; instructorEl.value="";
    roomEl.value=""; dayEl.value="Mon"; startEl.value=fromMin24(startMin);
    durEl.value = isRamadan ? (dayEl.value==="Fri" ? "40" : "55") : "60"; notesEl.value="";
    selectedId = "";
    selInfoEl.textContent = "";
  }

  function loadIntoEditor(c){
    courseEl.value = c.course || "";
    sectionEl.value = c.section || "";
    instructorEl.value = c.instructor || "";
    roomEl.value = c.room || "";
    dayEl.value = c.day || "Mon";
    buildStartOptionsForDay(dayEl.value);
    setDurOptionsForDay(dayEl.value);
    startEl.value = c.start || fromMin24(startMin);
    durEl.value = String(c.dur || (isRamadan ? (dayEl.value==="Fri" ? 40 : 55) : 60));
    notesEl.value = c.notes || "";
    selectedId = c.id;
    selInfoEl.textContent = `Selected: ${c.course || "-"} (${to12h(c.start)}), ID: ${c.id}`;
  }

  function keyFieldForMode(mode){
    if(mode === "room") return "room";
    if(mode === "section") return "section";
    if(mode === "course") return "course";
    return "instructor";
  }

  function getRowsForMode(mode){
    if (Array.isArray(userRowsByMode[mode]) && userRowsByMode[mode].length) return [...userRowsByMode[mode]];
    const field = keyFieldForMode(mode);
    const keys = Array.from(new Set(classes.map(c => (c[field] || "").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));
    if (keys.length) return keys;
    return [...(defaultsByMode[mode] || [])];
  }

  function timeSlots(){
    const slots = [];
    for(let t=startMin; t<=endMin; t+=slotSize) slots.push(t);
    return slots;
  }
  function snapMinToSlot(mins){
    const rel = mins - startMin;
    const snapped = Math.round(rel / slotSize) * slotSize + startMin;
    return Math.max(startMin, Math.min(endMin, snapped));
  }
  function durationToSpan(dur){
    return Math.max(1, Math.round(dur / slotSize));
  }
  function fmtRange(c){
    const s = to12h(c.start);
    const e = fromMin12(toMin(c.start) + Number(c.dur));
    return `${s} to ${e}`;
  }
  function rangesOverlap(c1, c2){
    const aS=toMin(c1.start), aE=aS + Number(c1.dur);
    const bS=toMin(c2.start), bE=bS + Number(c2.dur);
    return overlaps(aS,aE,bS,bE);
  }

  function computeConflictsAll(){
    const types = ["room","instructor","section"];
    const out = { room: [], instructor: [], section: [] };

    for (const t of types){
      const field = t;
      const map = new Map();
      for (const c of classes){
        const kVal = (c[field] || "").trim();
        if (!kVal) continue;
        const k = `${kVal}|${c.day}`;
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(c);
      }
      for (const list of map.values()){
        list.sort((a,b)=>toMin(a.start)-toMin(b.start));
        for (let i=0;i<list.length;i++){
          for (let j=i+1;j<list.length;j++){
            const a=list[i], b=list[j];
            if (a.day !== b.day) continue;
            if (!rangesOverlap(a,b)) continue;
            out[t].push({ type: t, key: (a[field]||"").trim(), day: a.day, aId: a.id, bId: b.id, a, b });
          }
        }
      }
    }
    return out;
  }

  function conflictIdsForCurrentView(confAll){
    const keyField = keyFieldForMode(rowMode);
    const ids = new Set();
    for (const it of (confAll[keyField] || [])){
      ids.add(it.aId); ids.add(it.bId);
    }
    return ids;
  }

  function assignOverlapLevels(items){
    const sorted = [...items].sort((a,b)=>toMin(a.start)-toMin(b.start));
    const levels = [];
    const placed = [];

    for (const c of sorted){
      const s = toMin(c.start);
      const e = s + Number(c.dur);
      let lvl = -1;

      for (let i=0;i<levels.length;i++){
        if (s >= levels[i].lastEnd){
          lvl = i;
          break;
        }
      }
      if (lvl === -1){
        levels.push({ lastEnd: e });
        lvl = levels.length - 1;
      } else {
        levels[lvl].lastEnd = e;
      }
      placed.push({ c, level: lvl });
    }
    return { placed, levelCount: Math.max(1, levels.length) };
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function shareText(title, text){
    if (!navigator.share){
      showMsg("Share not supported. Use Copy JSON or Download JSON.", "warn");
      return;
    }
    try{
      await navigator.share({ title, text });
      showMsg("Shared.", "ok");
    } catch(e){
      showMsg("Share canceled or failed.", "warn");
    }
  }

  function openConfModal(){ $("confModal").style.display="flex"; }
  function closeConfModal(){ $("confModal").style.display="none"; }

  function renderConflicts(confAll){
    const filter = $("confFilter").value;
    const listEl = $("confList");
    listEl.innerHTML = "";

    const roomN = confAll.room.length;
    const instN = confAll.instructor.length;
    const secN  = confAll.section.length;
    $("confSummary").textContent = `Room: ${roomN}, Instructor: ${instN}, Section: ${secN}`;

    const merged = [];
    for (const t of ["room","instructor","section"]) for (const it of confAll[t]) merged.push(it);
    const items = (filter === "all") ? merged : confAll[filter];

    if (!items.length){
      listEl.innerHTML = `<div class="smallText">No conflicts found for this filter.</div>`;
      return;
    }

    const dayOrder = {Mon:1,Tue:2,Wed:3,Thu:4,Fri:5};
    items.sort((x,y)=>{
      const d = (dayOrder[x.day]||99) - (dayOrder[y.day]||99);
      if (d !== 0) return d;
      return toMin(x.a.start) - toMin(y.a.start);
    });

    for (const it of items){
      const typeLabel = it.type === "room" ? "Room conflict" : (it.type === "instructor" ? "Instructor conflict" : "Section conflict");
      const row = document.createElement("div");
      row.className = "confRow";
      row.innerHTML = `
        <div class="k">
          <span class="confBadge">${escapeHtml(typeLabel)}</span>
          <span>Key: ${escapeHtml(it.key)} | Day: ${escapeHtml(it.day)}</span>
        </div>
        <div class="v">${escapeHtml(fmtRange(it.a))} overlaps ${escapeHtml(fmtRange(it.b))}</div>
        <div class="k" style="margin-top:6px">
          A: ${escapeHtml(it.a.course||"-")} ${it.a.section?`(${escapeHtml(it.a.section)})`:""} | Room: ${escapeHtml(it.a.room||"-")} | Instructor: ${escapeHtml(it.a.instructor||"-")}
          <br>
          B: ${escapeHtml(it.b.course||"-")} ${it.b.section?`(${escapeHtml(it.b.section)})`:""} | Room: ${escapeHtml(it.b.room||"-")} | Instructor: ${escapeHtml(it.b.instructor||"-")}
        </div>
      `;
      listEl.appendChild(row);
    }
  }

  function makePayload(){
    return { version:2, scheduleMode: (isRamadan ? "ramadan" : "regular"), rowMode, rowsByMode: userRowsByMode, startMin, endMin, slotSize, classes };
  }


function applyPayload(payload){
  if(!payload || !Array.isArray(payload.classes)) throw new Error("Invalid payload");
  classes = payload.classes;
  rowMode = payload.rowMode || "room";
  startMin = Number(payload.startMin ?? startMin);
  endMin = Number(payload.endMin ?? endMin);
  slotSize = Number(payload.slotSize ?? slotSize);

  // Schedule mode (backward compatible)
  if(payload.scheduleMode === "ramadan"){
    setRamadanMode(true, true);
  } else {
    setRamadanMode(false, true);
  }

  if (payload.rowsByMode && typeof payload.rowsByMode === "object") {
    userRowsByMode.room = payload.rowsByMode.room || null;
    userRowsByMode.section = payload.rowsByMode.section || null;
    userRowsByMode.instructor = payload.rowsByMode.instructor || null;
  }

  rowModeEl.value = rowMode;
  dayStartEl.value = fromMin24(startMin);
  dayEndEl.value = fromMin24(endMin);
  slotSizeEl.value = String(slotSize);

  buildStartOptionsForDay(dayEl.value);
  setDurOptionsForDay(dayEl.value);
  clearEditor();
  render();
}


function queueAutoSave(){
  if(!firebaseReady || !isAdmin) return;
  if(autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(()=>{ cloudSaveDraftPayload().catch(()=>{}); }, AUTO_SAVE_MS);
}

/* Firestore doc schema (single doc):
   - publishedData: stringified payload
   - publishedVersion: number
   - publishedAt: timestamp
   - diffMap: { [classId]: { type: "added"|"updated", fields?: string[] } }
   - deleted: [{ id, course, section, instructor, room, day, start, dur }]
   - draftData: stringified payload
   - draftUpdatedAt: timestamp
   Backward compatibility: if "data" exists, it is treated as publishedData.
*/

function normalizeDocData(docData){
  const publishedData = docData.publishedData || docData.data || null;
  const publishedVersion = Number(docData.publishedVersion || 1);
  const diffMap = docData.diffMap && typeof docData.diffMap === "object" ? docData.diffMap : {};
  const deleted = Array.isArray(docData.deleted) ? docData.deleted : [];
  const draftData = docData.draftData || null;
  return { publishedData, publishedVersion, diffMap, deleted, draftData };
}

function diffPayload(prevPayload, nextPayload){
  const prev = new Map((prevPayload?.classes || []).map(c=>[c.id, c]));
  const next = new Map((nextPayload?.classes || []).map(c=>[c.id, c]));

  const diffMap = {};
  const deleted = [];

  for (const [id, cNext] of next.entries()){
    const cPrev = prev.get(id);
    if(!cPrev){
      diffMap[id] = { type:"added" };
      continue;
    }
    const fields = [];
    for (const k of ["course","section","instructor","room","day","start","dur","notes"]){
      const a = (cPrev[k] ?? "");
      const b = (cNext[k] ?? "");
      if (String(a) !== String(b)) fields.push(k);
    }
    if(fields.length){
      diffMap[id] = { type:"updated", fields };
    }
  }

  for (const [id, cPrev] of prev.entries()){
    if(!next.has(id)){
      deleted.push({
        id: cPrev.id,
        course: cPrev.course || "",
        section: cPrev.section || "",
        instructor: cPrev.instructor || "",
        room: cPrev.room || "",
        day: cPrev.day || "",
        start: cPrev.start || "",
        dur: Number(cPrev.dur || 0)
      });
    }
  }
  return { diffMap, deleted };
}

let publishedVersion = 1;
let changeMap = {};
let deletedChanges = [];

function updateVersionUI(){
  const vEl = $("verPill");
  if(vEl) vEl.textContent = `v${publishedVersion}`;
}

async function cloudSaveDraftPayload(){
  if(!firebaseReady) { showMsg("Firebase is not ready. Check internet, authorized domain, and FIREBASE_CONFIG.", "warn"); return; }
  if(!isAdmin) { showMsg("View-only. Admin login required to save.", "warn"); return; }

  const payload = makePayload();
  const docRef = firebase.firestore().doc(CLOUD_DOC_PATH);
  await docRef.set({
    draftData: JSON.stringify(payload),
    draftUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
  showMsg("Draft saved.", "ok");
}

async function cloudPublishDraft(){
  if(!firebaseReady) { showMsg("Firebase is not ready. Check internet, authorized domain, and FIREBASE_CONFIG.", "warn"); return; }
  if(!isAdmin) { showMsg("View-only. Admin login required to publish.", "warn"); return; }

  const docRef = firebase.firestore().doc(CLOUD_DOC_PATH);
  const snap = await docRef.get();
  const docData = snap.exists ? snap.data() : {};
  const norm = normalizeDocData(docData);

  const prevPublished = norm.publishedData ? JSON.parse(norm.publishedData) : { classes: [] };
  const nextPublished = makePayload();

  const { diffMap, deleted } = diffPayload(prevPublished, nextPublished);
  const nextVersion = (Number(norm.publishedVersion || 1) || 1) + 1;

  await docRef.set({
    publishedData: JSON.stringify(nextPublished),
    publishedVersion: nextVersion,
    publishedAt: firebase.firestore.FieldValue.serverTimestamp(),
    diffMap,
    deleted,
    // keep draft as-is (optional). If you prefer clearing draft after publish, set draftData:null.
  }, { merge:true });

  publishedVersion = nextVersion;
  changeMap = diffMap;
  deletedChanges = deleted;
  updateVersionUI();

  showMsg(`Published v${nextVersion}.`, "ok");
}

async function cloudLoadPublished(){
  if(!firebaseReady) { showMsg("Firebase is not ready. Check internet, authorized domain, and FIREBASE_CONFIG.", "warn"); return; }
  const docRef = firebase.firestore().doc(CLOUD_DOC_PATH);
  const snap = await docRef.get();
  if(!snap.exists){
    showMsg("No published timetable found yet. Admin can create a draft and Publish.", "warn");
    return;
  }
  const norm = normalizeDocData(snap.data());
  if(!norm.publishedData){
    showMsg("No published timetable found yet. Admin can create a draft and Publish.", "warn");
    return;
  }
  const payload = JSON.parse(norm.publishedData);

  publishedVersion = norm.publishedVersion;
  changeMap = norm.diffMap || {};
  deletedChanges = norm.deleted || [];
  updateVersionUI();

  applyPayload(payload);

  showMsg(`Loaded published v${publishedVersion}.`, "ok");
}

async function cloudLoadDraftOrPublished(){
  if(!firebaseReady) { showMsg("Firebase is not ready. Check internet, authorized domain, and FIREBASE_CONFIG.", "warn"); return; }
  const docRef = firebase.firestore().doc(CLOUD_DOC_PATH);
  const snap = await docRef.get();
  if(!snap.exists){
    showMsg("No cloud timetable found yet. Create a draft and Publish.", "warn");
    return;
  }
  const norm = normalizeDocData(snap.data());
  const dataStr = (norm.draftData || norm.publishedData);
  if(!dataStr){
    showMsg("No cloud timetable found yet. Create a draft and Publish.", "warn");
    return;
  }
  const payload = JSON.parse(dataStr);

  publishedVersion = norm.publishedVersion;
  changeMap = {}; // draft editing should not inherit highlight state
  deletedChanges = [];
  updateVersionUI();

  applyPayload(payload);

  showMsg(norm.draftData ? "Loaded draft (unpublished)." : `Loaded published v${publishedVersion}.`, "ok");
}


function setAdminMode(state, userEmail){
  isAdmin = !!state;
  const pill = $("authPill");
  pill.textContent = isAdmin ? `Mode: Admin (${userEmail || "signed in"})` : "Mode: Viewer";

  $("loginBtn").classList.toggle("hidden", isAdmin);
  $("logoutBtn").classList.toggle("hidden", !isAdmin);
  $("draftSaveBtn").classList.toggle("hidden", !isAdmin);
  $("publishBtn").classList.toggle("hidden", !isAdmin);

  // Hide the whole editor panel for viewers
  $("editorCard").classList.toggle("hidden", !isAdmin);

  // Admin-only view option(s)
  [rowModeEl, rowModeTopEl].forEach(sel => {
    if(!sel) return;
    Array.from(sel.options).forEach(o => {
      if(o.dataset && o.dataset.adminOnly === "1") o.hidden = !isAdmin;
    });
  });
  if(!isAdmin && rowMode === "course"){
    rowMode = "room";
  }

  // Keep top view controls in sync
  const rmTop = $("rowModeTop");
  if(rmTop) rmTop.value = rowMode;

  // For viewers, ensure nothing can be dragged/dropped/edited
  document.body.classList.toggle("viewerMode", !isAdmin);
}

async function initFirebase(){
  // If firebase scripts could not load (offline, blocked, or opened in a restricted context)
  if(typeof firebase === "undefined"){
    firebaseReady = false;
    showMsg("Firebase libraries did not load. Check internet access, and open this file via http(s) (for example http://localhost) rather than file://.", "warn");
    setAdminMode(false);
    return;
  }

  if(hasPlaceholders(FIREBASE_CONFIG)){
    firebaseReady = false;
    showMsg("Firebase placeholders detected. Paste your firebaseConfig values and admin email.", "warn");
    setAdminMode(false);
    return;
  }
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseReady = true;

    firebase.auth().onAuthStateChanged(async (user)=>{
      const email = user?.email || "";
      const ok = !!user && email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
      setAdminMode(ok, email);

      // On auth resolve: admin loads draft (or published), viewer loads published
      try{ await (ok ? cloudLoadDraftOrPublished() : cloudLoadPublished()); } catch(e){ /* handled by load */ }
    });
  } catch(e){
    firebaseReady = false;
    showMsg("Firebase init failed. Check config values.", "bad");
    setAdminMode(false);
  }
}

  function render(){
    hideMsg();

    const allRows = getRowsForMode(rowMode);
    const rows = (rowFilter && rowFilter !== "__all__") ? [rowFilter] : allRows;
    const slots = timeSlots();
    const gridTemplate = `var(--labelW) repeat(${slots.length}, var(--slotW))`;

    const confAll = computeConflictsAll();
    const total = confAll.room.length + confAll.instructor.length + confAll.section.length;
    confStatEl.textContent = `Conflicts: ${total} (Room ${confAll.room.length}, Instructor ${confAll.instructor.length}, Section ${confAll.section.length})`;

    const conflictIds = conflictIdsForCurrentView(confAll);

    const modeLabel = rowMode === "room" ? "Rooms" : (rowMode === "section" ? "Sections" : "Instructors");
    gridSubEl.textContent = `Rows: ${modeLabel}`;
    rowListEl.value = allRows.join(", ");

    // Sync top controls
    if (rowModeTopEl) rowModeTopEl.value = rowMode;
    if (rowFilterTopEl) {
      const prev = rowFilter;
      rowFilterTopEl.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "__all__";
      optAll.textContent = "All";
      rowFilterTopEl.appendChild(optAll);
      for (const k of allRows) {
        const o = document.createElement("option");
        o.value = k;
        o.textContent = k;
        rowFilterTopEl.appendChild(o);
      }
      // restore previous if still valid
      if (prev && (prev === "__all__" || allRows.includes(prev))) rowFilter = prev;
      rowFilterTopEl.value = rowFilter;
    }

    gridRoot.innerHTML = "";

    const keyField = keyFieldForMode(rowMode);

    for(const rowKey of rows){
      const panel = document.createElement("div");
      panel.className = "rowPanel";

      const head = document.createElement("div");
      head.className = "rowPanelHead";

      const rk = document.createElement("div");
      rk.className = "rowKey";
      rk.textContent = rowKey || "(empty)";

      const meta = document.createElement("div");
      meta.className = "rowMeta";
      meta.textContent = `${fromMin12(startMin)} to ${fromMin12(endMin)}, slot ${slotSize} min`;

      head.appendChild(rk);
      head.appendChild(meta);
      panel.appendChild(head);

      const header = document.createElement("div");
      header.className = "timeHeader";
      header.style.gridTemplateColumns = gridTemplate;

      const blank = document.createElement("div");
      blank.className = "timeHeadCell";
      blank.textContent = "";
      header.appendChild(blank);

      for(const t of slots){
        const c = document.createElement("div");
        c.className = "timeHeadCell";
        if(isRamadan && slotSize <= 5){
          c.textContent = (t === startMin || (t % 30 === 0)) ? fromMin12(t) : "";
        } else {
          c.textContent = fromMin12(t);
        }
        header.appendChild(c);
      }
      panel.appendChild(header);

      const lanes = document.createElement("div");
      lanes.className = "laneGrid";
      lanes.style.gridTemplateColumns = gridTemplate;

      for(const d of days){
        const dayLabel = document.createElement("div");
        dayLabel.className = "dayLabel";
        dayLabel.textContent = d;
        lanes.appendChild(dayLabel);

        const lane = document.createElement("div");
        lane.className = "lane";
        lane.dataset.rowKey = rowKey;
        lane.dataset.day = d;
        lane.style.gridColumn = `2 / span ${slots.length}`;

        const bg = document.createElement("div");
        bg.className = "bgTicks";
        bg.style.gridTemplateColumns = `repeat(${slots.length}, var(--slotW))`;
        for(let i=0;i<slots.length;i++) bg.appendChild(document.createElement("div"));
        lane.appendChild(bg);

        lane.addEventListener("dragover", (e)=>{ if(!isAdmin) return; e.preventDefault(); lane.classList.add("dropHover"); });
        lane.addEventListener("dragleave", ()=>lane.classList.remove("dropHover"));
        lane.addEventListener("drop", (e)=>{
          e.preventDefault();
          lane.classList.remove("dropHover");

          if(!isAdmin){ showMsg("View-only. Admin login required to edit.", "warn"); return; }

          const id = e.dataTransfer.getData("text/plain");
          if (!id) return;

          const cls = classes.find(x=>x.id===id);
          if(!cls) return;

          const rect = lane.getBoundingClientRect();
          const w = Math.max(1, rect.width);
          const x = Math.max(0, Math.min(w, e.clientX - rect.left));
          const frac = x / w;

          const totalSpanMin = (endMin - startMin);
          const rawMin = startMin + frac * totalSpanMin;
          const newStart = isRamadan ? snapMinToAllowed(rawMin, d) : snapMinToSlot(rawMin);

          cls.day = d;
          cls[keyField] = rowKey;
          cls.start = fromMin24(newStart);

          render();
        });

        const items = classes.filter(c => (c[keyField]||"").trim() === rowKey && c.day === d);
        const { placed, levelCount } = assignOverlapLevels(items);

        const laneInner = document.createElement("div");
        laneInner.style.position = "absolute";
        laneInner.style.inset = "10px";
        laneInner.style.display = "grid";
        laneInner.style.gridTemplateColumns = `repeat(${slots.length}, var(--slotW))`;
        laneInner.style.gridTemplateRows = `repeat(${levelCount}, minmax(150px, auto))`;
        laneInner.style.gap = "10px";
        laneInner.style.pointerEvents = "none";
        lane.appendChild(laneInner);

        /* More vertical space per overlap level so nothing is cut.
           If a lane has no classes, keep it compact (like only the day label). */
        const hasItems = placed.length > 0;
        if(!hasItems){
          const compactH = 56; // compact row height when empty
          lane.style.minHeight = `${compactH}px`;
          dayLabel.style.minHeight = `${compactH}px`;
          laneInner.style.inset = "8px";
        } else {
          const base = 140;
          const perLevel = 170;
          const targetH = Math.max(base, perLevel * levelCount);
          lane.style.minHeight = `${targetH}px`;
          dayLabel.style.minHeight = `${targetH}px`;
        }

for(const p of placed){
          const c = p.c;

          const block = document.createElement("div");
          const ch = (!isAdmin && changeMap && changeMap[c.id]) ? changeMap[c.id] : null;
          block.className = "block"
            + (conflictIds.has(c.id) ? " conflict" : "")
            + (c.id === selectedId ? " selected" : "")
            + (ch && ch.type === "added" ? " added" : "")
            + (ch && ch.type === "updated" ? " updated" : "");
          block.draggable = isAdmin;
          block.style.pointerEvents = "auto";

          block.addEventListener("dragstart", (ev)=>{ if(!isAdmin) return; ev.dataTransfer.setData("text/plain", c.id); });
          block.addEventListener("click", (ev)=>{
            ev.stopPropagation();
            if(!isAdmin){ return; }
            loadIntoEditor(c);
            render();
          });

          const title = `${c.course || "(no course)"}${c.section ? ` (${c.section})` : ""}`;
          const meta1 = `Room: ${c.room || "-"} | Instructor: ${c.instructor || "-"} | Section: ${c.section || "-"}`;
          const meta2 = `Time: ${to12h(c.start)} (${c.dur} min)`;

          const notesHtml = c.notes
            ? `<div class="notes">${escapeHtml("Notes: " + c.notes)}</div>`
            : "";

          block.innerHTML = `
            <div class="t">${escapeHtml(title)}</div>
            <div class="s">
              ${escapeHtml(meta1)}<br>
              ${escapeHtml(meta2)}
              ${notesHtml}
            </div>
            <div class="chip">${escapeHtml(d)} • ${escapeHtml(to12h(c.start))} • ${escapeHtml((c[keyField]||"").trim())}</div>
          `;

          const startM = toMin(c.start);
          const startCol = Math.max(1, Math.min(slots.length, Math.round((startM - startMin)/slotSize) + 1));
          const span = durationToSpan(Number(c.dur));

          block.style.gridColumn = `${startCol} / span ${span}`;
          block.style.gridRow = `${p.level + 1}`;

          laneInner.appendChild(block);
        }

        lanes.appendChild(lane);
      }

      panel.appendChild(lanes);
      gridRoot.appendChild(panel);
    }

    if ($("confModal").style.display === "flex"){
      renderConflicts(computeConflictsAll());
    }
  }

  /* UI wiring */


// Cloud controls
$("loginBtn").addEventListener("click", async ()=>{
  if(!firebaseReady){ showMsg("Firebase is not ready. Check internet, authorized domain, and FIREBASE_CONFIG.", "warn"); return; }
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await firebase.auth().signInWithPopup(provider);
  } catch(e){
    showMsg("Login failed or canceled.", "warn");
  }
});

$("logoutBtn").addEventListener("click", async ()=>{
  if(!firebaseReady) return;
  try{ await firebase.auth().signOut(); } catch(e){}
});

$("draftSaveBtn").addEventListener("click", ()=>{ cloudSaveDraftPayload().catch(()=>showMsg("Draft save failed.", "bad")); });
$("publishBtn").addEventListener("click", ()=>{ cloudPublishDraft().catch(()=>showMsg("Publish failed.", "bad")); });
$("cloudLoadBtn").addEventListener("click", ()=>{ (isAdmin ? cloudLoadDraftOrPublished() : cloudLoadPublished()).catch(()=>showMsg("Reload failed.", "bad")); });

  $("ramadanToggleBtn").addEventListener("click", ()=>{
    setRamadanMode(!isRamadan);
  });

  buildBoundaryOptions(dayStartEl, 6*60, 12*60, 30);
  buildBoundaryOptions(dayEndEl, 13*60+30, 22*60, 30);
  dayStartEl.value = fromMin24(startMin);
  dayEndEl.value = fromMin24(endMin);
  buildStartOptionsForDay(dayEl.value);
  setDurOptionsForDay(dayEl.value);


  dayEl.addEventListener("change", ()=>{
    buildStartOptionsForDay(dayEl.value);
    setDurOptionsForDay(dayEl.value);
    if(isRamadan){
      const cur = toMin(startEl.value || fromMin24(startMin));
      startEl.value = fromMin24(snapMinToAllowed(cur, dayEl.value));
    }
  });

  $("newBtn").addEventListener("click", ()=>{
    clearEditor();
    showMsg("New class mode.", "ok");
    render();
    queueAutoSave();
  });

  $("saveBtn").addEventListener("click", ()=>{
    const course = courseEl.value.trim();
    const section = sectionEl.value.trim();
    const instructor = instructorEl.value.trim();
    const room = roomEl.value.trim();
    const day = dayEl.value;
    const start = startEl.value;
    const dur = Number(durEl.value);
    const notes = notesEl.value.trim();

    if(!course){
      showMsg("Course is required.", "bad");
      return;
    }

    if (selectedId){
      const c = classes.find(x=>x.id===selectedId);
      if (c){
        c.course=course; c.section=section; c.instructor=instructor; c.room=room;
        c.day=day; c.start=start; c.dur=dur; c.notes=notes;
        showMsg("Class updated.", "ok");
        render();
        queueAutoSave();
        return;
      }
    }

    const id = uuid();
    classes.push({ id, course, section, instructor, room, day, start, dur, notes });
    selectedId = id;
    selInfoEl.textContent = `Selected: ${course} (${to12h(start)}), ID: ${id}`;
    showMsg("Class added.", "ok");
    render();
    queueAutoSave();
  });

  $("deleteBtn").addEventListener("click", ()=>{
    if (!selectedId){
      showMsg("Select a class first.", "warn");
      return;
    }
    classes = classes.filter(c => c.id !== selectedId);
    clearEditor();
    showMsg("Deleted.", "ok");
    render();
    queueAutoSave();
  });

  $("applyRows").addEventListener("click", ()=>{
    const text = rowListEl.value.trim();
    const list = text ? text.split(",").map(s=>s.trim()).filter(Boolean) : [];
    userRowsByMode[rowMode] = list.length ? list : null;
    showMsg("Row list updated for this view mode.", "ok");
    render();
    queueAutoSave();
  });

  $("resetBtn").addEventListener("click", ()=>{
    classes = [];
    userRowsByMode.room = null;
    userRowsByMode.section = null;
    userRowsByMode.instructor = null;
    clearEditor();
    showMsg("Reset completed.", "warn");
    render();
    queueAutoSave();
  });

  rowModeEl.addEventListener("change", ()=>{
    rowMode = rowModeEl.value;
    render();
    queueAutoSave();
  });

  if(rowModeTopEl){
    rowModeTopEl.addEventListener("change", ()=>{
      rowMode = rowModeTopEl.value;
      rowFilter = "__all__";
      if(rowModeEl) rowModeEl.value = rowMode;
      render();
      queueAutoSave();
    });
  }
  if(rowFilterTopEl){
    rowFilterTopEl.addEventListener("change", ()=>{
      rowFilter = rowFilterTopEl.value || "__all__";
      render();
    });
  }

  slotSizeEl.addEventListener("change", ()=>{
    slotSize = Number(slotSizeEl.value);
    buildStartOptionsForDay(dayEl.value);
    startEl.value = fromMin24(startMin);
    render();
    queueAutoSave();
  });

  dayStartEl.addEventListener("change", ()=>{
    startMin = toMin(dayStartEl.value);
    buildStartOptionsForDay(dayEl.value);
    startEl.value = fromMin24(startMin);
    render();
    queueAutoSave();
  });

  dayEndEl.addEventListener("change", ()=>{
    endMin = toMin(dayEndEl.value);
    buildStartOptionsForDay(dayEl.value);
    startEl.value = fromMin24(startMin);
    render();
    queueAutoSave();
  });

  $("downloadJsonBtn").addEventListener("click", ()=>{
    const json = JSON.stringify(makePayload(), null, 2);
    downloadText("timetable.json", json);
    showMsg("Downloaded timetable.json.", "ok");
  });

  $("copyJsonBtn").addEventListener("click", async ()=>{
    const json = JSON.stringify(makePayload(), null, 2);
    await navigator.clipboard.writeText(json);
    showMsg("JSON copied to clipboard.", "ok");
  });

  $("printBtn").addEventListener("click", ()=>window.print());

  $("shareBtn").addEventListener("click", async ()=>{
    const json = JSON.stringify(makePayload(), null, 2);
    await shareText("University Timetable", json);
  });

  $("importBtn").addEventListener("click", ()=>{
    const json = prompt("Paste exported JSON here:");
    if(!json) return;
    try{
      const payload = JSON.parse(json);
      if(!payload || !Array.isArray(payload.classes)) throw new Error("Invalid format");

      classes = payload.classes;
      rowMode = payload.rowMode || "room";
      startMin = Number(payload.startMin ?? startMin);
      endMin = Number(payload.endMin ?? endMin);
      slotSize = Number(payload.slotSize ?? slotSize);

      if(payload.scheduleMode === "ramadan"){
        setRamadanMode(true, true);
      } else {
        setRamadanMode(false, true);
      }

      if (payload.rowsByMode && typeof payload.rowsByMode === "object") {
        userRowsByMode.room = payload.rowsByMode.room || null;
        userRowsByMode.section = payload.rowsByMode.section || null;
        userRowsByMode.instructor = payload.rowsByMode.instructor || null;
      }

      rowModeEl.value = rowMode;
      dayStartEl.value = fromMin24(startMin);
      dayEndEl.value = fromMin24(endMin);
      slotSizeEl.value = String(slotSize);

      buildStartOptionsForDay(dayEl.value);
      setDurOptionsForDay(dayEl.value);

      clearEditor();
      showMsg("Imported successfully.", "ok");
      render();
      queueAutoSave();
    } catch(e){
      showMsg("Import failed. JSON format not recognized.", "bad");
    }
  });

  $("confBtn").addEventListener("click", ()=>{
    const confAll = computeConflictsAll();
    $("confFilter").value = "all";
    renderConflicts(confAll);
    openConfModal();
  });
  $("closeConf").addEventListener("click", closeConfModal);
  $("confModal").addEventListener("click", (e)=>{
    if (e.target && e.target.id === "confModal") closeConfModal();
  });
  $("confFilter").addEventListener("change", ()=>renderConflicts(computeConflictsAll()));

  /* Initial */
  setAdminMode(false);
  initFirebase();
  // If not logged in (viewer), try to load published after init.
  setTimeout(()=>{ if(firebaseReady && !isAdmin) cloudLoadPublished().catch(()=>{}); }, 800);
  setRamadanMode(false, true);
  clearEditor();
  render();
</script>
</body>
</html>
